/* plus/assets/libs/marked.min.js
   极简 Markdown 解析器（支持常用标题/粗体/斜体/链接/代码块/列表/段落）
   仅为演示用途，建议后续替换为官方 marked v* 纯 JS 文件。 */
!function(g){
  function esc(s){return s.replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m]))}
  function inline(s){
    s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
    s = s.replace(/\*(.+?)\*/g,'<em>$1</em>');
    s = s.replace(/`([^`]+?)`/g,'<code>$1</code>');
    s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
    return s;
  }
  function parse(md){
    const lines = md.replace(/\r\n?/g,"\n").split("\n");
    let html=[], inCode=false, codeLang='', inList=false;
    for(let i=0;i<lines.length;i++){
      let l=lines[i];
      if (/^```/.test(l)){
        if(!inCode){ inCode=true; codeLang=l.replace(/^```/,'').trim(); html.push('<pre><code>'); }
        else { inCode=false; html.push('</code></pre>'); }
        continue;
      }
      if(inCode){ html.push(esc(l)+"\n"); continue; }

      if(/^#{1,6}\s+/.test(l)){
        const m=l.match(/^(#+)\s+(.*)$/); const h=m[1].length; html.push(`<h${h}>${inline(esc(m[2]))}</h${h}>`); inList=false; continue;
      }
      if (/^\s*[-*+]\s+/.test(l)){
        if(!inList){ html.push('<ul>'); inList=true;}
        html.push('<li>'+ inline(esc(l.replace(/^\s*[-*+]\s+/,''))) +'</li>');
        if(i+1>=lines.length || !/^\s*[-*+]\s+/.test(lines[i+1])){ html.push('</ul>'); inList=false; }
        continue;
      }
      if (l.trim()===''){ html.push(''); continue; }
      html.push('<p>'+ inline(esc(l)) +'</p>');
      inList=false;
    }
    return html.join("\n");
  }
  g.marked = { parse };
}(window);
